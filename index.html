<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Random Crap</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/x-icon" href="favicon.svg">
  <link rel="apple-touch-icon" href="favicon.svg">
  
  <!-- Meta tags -->
  <meta name="description" content="A minimalist static microblogging platform using GitHub for auth and Gists for storage">
  <meta name="author" content="Atharva Kulkarni">
  <meta name="keywords" content="microblog, github, gists, static, serverless">
  
  <!-- Cache control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: monospace; 
      max-width: 600px; 
      margin: 0 auto; 
      padding: 20px;
      line-height: 1.6;
    }
    input[type="email"], input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      font-family: monospace;
      font-size: 16px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      background: #000;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin-right: 10px;
      cursor: pointer;
      font-family: monospace;
    }
    button:hover { background: #333; }
    button:disabled { 
      background: #999; 
      cursor: not-allowed;
    }
    .post {
      border-bottom: 1px solid #eee;
      padding: 20px 0;
    }
    .post-content {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .post-meta {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .post-actions {
      margin-top: 10px;
    }
    .post-actions button {
      font-size: 12px;
      padding: 5px 10px;
      margin-right: 5px;
    }
    .editing textarea {
      margin-top: 10px;
    }
    .versions {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      font-size: 12px;
    }
    .version {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    .version:last-child { border: none; }
    .char-count {
      font-size: 12px;
      color: #666;
      text-align: right;
      margin-top: 5px;
    }
    .char-count.over { color: red; }
    .auth-container {
      margin: 50px 0;
      text-align: center;
    }
    .tab-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    .tab-button {
      background: #f0f0f0;
      color: #000;
      padding: 10px 30px;
      border: none;
      cursor: pointer;
      font-family: monospace;
      font-size: 16px;
    }
    .tab-button.active {
      background: #000;
      color: #fff;
    }
    .auth-form {
      max-width: 300px;
      margin: 0 auto;
    }
    .auth-form input {
      margin-bottom: 15px;
    }
    .otp-inputs {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }
    .otp-input {
      width: 40px;
      height: 50px;
      text-align: center;
      font-size: 20px;
      font-family: monospace;
    }
    #app {
      display: none;
    }
    .error {
      color: red;
      font-size: 14px;
      margin-top: 10px;
    }
    .success {
      color: green;
      font-size: 14px;
      margin-top: 10px;
    }
    .info {
      color: #666;
      font-size: 14px;
      margin: 10px 0;
    }
    .username-check {
      font-size: 12px;
      margin-top: -10px;
      margin-bottom: 10px;
    }
    .username-check.available { color: green; }
    .username-check.taken { color: red; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .user-info {
      font-size: 14px;
    }
    .nav-links {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .nav-links a {
      color: #000;
      text-decoration: none;
    }
    .nav-links a:hover {
      text-decoration: underline;
    }
    .brand-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #000;
      color: #fff;
      text-align: center;
      padding: 10px;
      font-size: 12px;
    }
    .footer a {
      color: #fff;
      text-decoration: none;
    }
    .footer a:hover {
      text-decoration: underline;
    }
    body {
      padding-bottom: 50px;
    }
  </style>
</head>
<body>
  <div id="auth-container" class="auth-container">
    <h1 class="brand-title">The Random Crap</h1>
    
    <!-- GitHub Auth Form -->
    <div id="github-auth-form" class="auth-form">
      <p class="info">This app uses GitHub for authentication and stores data in GitHub Gists.</p>
      <input type="password" id="github-token" placeholder="GitHub Personal Access Token" />
      <div class="info">
        <a href="https://github.com/settings/tokens/new?scopes=gist&description=The%20Random%20Crap%20App" target="_blank">
          Create a GitHub token with 'gist' scope
        </a>
      </div>
      <button onclick="authenticateWithGitHub()">Connect with GitHub</button>
      <div id="auth-error" class="error"></div>
      <div id="auth-success" class="success"></div>
    </div>
  </div>

  <div id="app">
    <div class="header">
      <h2 id="page-title">Random Crap</h2>
      <div class="user-info">
        <span id="user-display"></span>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
    
    <div class="nav-links" id="nav-links">
      <a href="/" onclick="goHome(event)">Home</a>
      <a href="#" onclick="viewProfile(currentUser?.username, event)" id="profile-link">My Posts</a>
    </div>

    <div id="new-post">
      <textarea id="post-input" placeholder="What's on your mind?" maxlength="500"></textarea>
      <div class="char-count"><span id="char-count">0</span>/500</div>
      <button onclick="createPost()">Post</button>
    </div>
    
    <div id="posts"></div>
  </div>

  <script>
    let posts = []
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null')
    let viewingUser = null
    let usernameCheckTimeout = null
    let githubToken = localStorage.getItem('githubToken')
    let dataGistId = localStorage.getItem('dataGistId')
    
    // Global error handler
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error)
    })
    
    // Log when page loads
    console.log('The Random Crap loaded - GitHub Gist Version')

    // GitHub API functions
    async function githubRequest(url, options = {}) {
      if (!githubToken) {
        throw new Error('GitHub token required')
      }
      
      const response = await fetch(`https://api.github.com${url}`, {
        ...options,
        headers: {
          'Authorization': `token ${githubToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
          ...options.headers
        }
      })
      
      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`)
      }
      
      return response.json()
    }

    async function loadDataFromGist() {
      if (!dataGistId) return { posts: [], users: {} }
      
      try {
        const gist = await githubRequest(`/gists/${dataGistId}`)
        const data = JSON.parse(gist.files['data.json'].content)
        return data
      } catch (error) {
        console.error('Failed to load data from gist:', error)
        return { posts: [], users: {} }
      }
    }

    async function saveDataToGist(data) {
      const gistData = {
        description: 'The Random Crap - User Data',
        public: false,
        files: {
          'data.json': {
            content: JSON.stringify(data, null, 2)
          }
        }
      }
      
      try {
        if (dataGistId) {
          // Update existing gist
          await githubRequest(`/gists/${dataGistId}`, {
            method: 'PATCH',
            body: JSON.stringify(gistData)
          })
        } else {
          // Create new gist
          const gist = await githubRequest('/gists', {
            method: 'POST',
            body: JSON.stringify(gistData)
          })
          dataGistId = gist.id
          localStorage.setItem('dataGistId', dataGistId)
        }
      } catch (error) {
        console.error('Failed to save data to gist:', error)
        throw error
      }
    }

    // Check if already logged in
    if (currentUser && githubToken) {
      loadDataFromGist().then(data => {
        posts = data.posts || []
        showApp()
      })
    }

    // GitHub authentication
    async function authenticateWithGitHub() {
      const token = document.getElementById('github-token').value.trim()
      const errorDiv = document.getElementById('auth-error')
      const successDiv = document.getElementById('auth-success')
      
      errorDiv.textContent = ''
      successDiv.textContent = ''
      
      if (!token) {
        errorDiv.textContent = 'Please enter a GitHub token'
        return
      }
      
      try {
        // Verify token by fetching user info
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        })
        
        if (!response.ok) {
          throw new Error('Invalid token or insufficient permissions')
        }
        
        const userData = await response.json()
        
        // Store token and user data
        githubToken = token
        localStorage.setItem('githubToken', githubToken)
        
        currentUser = {
          id: userData.id,
          username: userData.login,
          name: userData.name || userData.login,
          avatar: userData.avatar_url
        }
        localStorage.setItem('currentUser', JSON.stringify(currentUser))
        
        successDiv.textContent = `Successfully authenticated as ${currentUser.username}!`
        
        // Load existing data or create new gist
        const data = await loadDataFromGist()
        posts = data.posts || []
        
        setTimeout(() => {
          showApp()
        }, 1000)
        
      } catch (error) {
        errorDiv.textContent = `Authentication failed: ${error.message}`
      }
    }
    
    // Enter key handler for token input
    document.getElementById('github-token').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') authenticateWithGitHub()
    })

    // Character counter
    document.getElementById('post-input').addEventListener('input', (e) => {
      const count = e.target.value.length
      document.getElementById('char-count').textContent = count
      document.querySelector('.char-count').classList.toggle('over', count > 500)
    })

    function logout() {
      currentUser = null
      githubToken = null
      dataGistId = null
      posts = []
      
      localStorage.removeItem('currentUser')
      localStorage.removeItem('githubToken')
      localStorage.removeItem('dataGistId')
      
      document.getElementById('auth-container').style.display = 'block'
      document.getElementById('app').style.display = 'none'
      
      // Clear form inputs
      document.getElementById('github-token').value = ''
      document.getElementById('auth-error').textContent = ''
      document.getElementById('auth-success').textContent = ''
    }

    function showApp() {
      document.getElementById('auth-container').style.display = 'none'
      document.getElementById('app').style.display = 'block'
      document.getElementById('user-display').textContent = `@${currentUser.username}`
      document.getElementById('profile-link').textContent = 'My Posts'
      
      // Check URL for user profile
      const path = window.location.pathname
      const match = path.match(/^\/([a-zA-Z0-9_-]+)(?:\/(\d+))?$/)
      
      if (match) {
        const username = match[1]
        const postId = match[2]
        viewProfile(username)
      } else {
        goHome()
      }
    }

    function loadPosts() {
      let filteredPosts
      
      if (viewingUser) {
        filteredPosts = posts.filter(p => p.username === viewingUser)
      } else {
        filteredPosts = posts.filter(p => p.username === currentUser?.username)
      }
      
      // Sort by creation date, newest first
      filteredPosts.sort((a, b) => new Date(b.created) - new Date(a.created))
      
      renderPosts(filteredPosts)
    }

    async function createPost() {
      const input = document.getElementById('post-input')
      const content = input.value.trim()
      
      if (!content) return
      if (content.length > 500) return
      
      // Get user's current post count for ID
      const userPosts = posts.filter(p => p.username === currentUser.username)
      const postId = userPosts.length + 1
      
      const post = {
        id: postId,
        username: currentUser.username,
        content: content,
        created: new Date().toISOString(),
        edited: false,
        versions: []
      }
      
      posts.unshift(post)
      
      try {
        // Save to gist
        await saveDataToGist({ posts })
        
        input.value = ''
        document.getElementById('char-count').textContent = '0'
        
        loadPosts()
      } catch (error) {
        console.error('Failed to create post:', error)
        alert('Failed to save post. Please try again.')
        // Remove the post from local array on failure
        posts = posts.filter(p => !(p.id === postId && p.username === currentUser.username))
        loadPosts()
      }
    }

    function editPost(id) {
      const userPosts = posts.filter(p => p.username === currentUser.username)
      const post = userPosts.find(p => p.id === id)
      const postEl = document.getElementById(`post-${id}`)
      
      postEl.classList.add('editing')
      postEl.innerHTML = `
        <textarea id="edit-${id}" maxlength="500">${post.content}</textarea>
        <div class="char-count"><span id="edit-char-${id}">${post.content.length}</span>/500</div>
        <div class="post-actions">
          <button onclick="saveEdit(${id})">Save</button>
          <button onclick="cancelEdit(${id})">Cancel</button>
        </div>
      `
      
      document.getElementById(`edit-${id}`).addEventListener('input', (e) => {
        document.getElementById(`edit-char-${id}`).textContent = e.target.value.length
      })
    }

    async function saveEdit(id) {
      const content = document.getElementById(`edit-${id}`).value.trim()
      if (!content) return
      
      try {
        const postIndex = posts.findIndex(p => p.username === currentUser.username && p.id === id)
        if (postIndex !== -1) {
          const post = posts[postIndex]
          
          // Save previous version
          post.versions.push({
            content: post.content,
            edited: post.edited || post.created
          })
          
          post.content = content
          post.edited = new Date().toISOString()
          
          // Save to gist
          await saveDataToGist({ posts })
          
          loadPosts()
        }
      } catch (error) {
        console.error('Failed to save edit:', error)
        alert('Failed to save changes. Please try again.')
        loadPosts()
      }
    }

    function cancelEdit(id) {
      loadPosts()
    }

    async function deletePost(id) {
      if (!confirm('Delete this post?')) return
      
      try {
        const postIndex = posts.findIndex(p => p.username === currentUser.username && p.id === id)
        if (postIndex !== -1) {
          posts.splice(postIndex, 1)
          
          // Save to gist
          await saveDataToGist({ posts })
          
          loadPosts()
        }
      } catch (error) {
        console.error('Failed to delete post:', error)
        alert('Failed to delete post. Please try again.')
        // Restore the post on failure (reload from gist)
        const data = await loadDataFromGist()
        posts = data.posts || []
        loadPosts()
      }
    }

    function toggleVersions(id) {
      const versionsEl = document.getElementById(`versions-${id}`)
      versionsEl.style.display = versionsEl.style.display === 'none' ? 'block' : 'none'
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleString()
    }

    function renderPosts(postsToRender) {
      const postsEl = document.getElementById('posts')
      const isOwnProfile = viewingUser === currentUser?.username || (!viewingUser && currentUser)
      
      postsEl.innerHTML = postsToRender.map(post => `
        <div class="post" id="post-${post.id}">
          <div class="post-content">${post.content}</div>
          <div class="post-meta">
            <a href="/${post.username}/${post.id}">#${post.id}</a> · ${formatDate(post.created)}
            ${post.edited ? ` · edited ${formatDate(post.edited)}` : ''}
          </div>
          ${isOwnProfile ? `
            <div class="post-actions">
              <button onclick="editPost(${post.id})">Edit</button>
              <button onclick="deletePost(${post.id})">Delete</button>
              ${post.versions.length > 0 ? 
                `<button onclick="toggleVersions(${post.id})">History (${post.versions.length})</button>` : 
                ''
              }
            </div>
          ` : ''}
          ${post.versions.length > 0 ? `
            <div class="versions" id="versions-${post.id}" style="display: none;">
              <strong>Edit History:</strong>
              ${post.versions.map((v, i) => `
                <div class="version">
                  <div>${v.content}</div>
                  <div style="color: #888; margin-top: 5px;">
                    ${formatDate(v.edited)}
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `).join('') || '<p style="text-align: center; color: #666; margin-top: 50px;">No posts yet</p>'
    }

    function goHome(e) {
      if (e) e.preventDefault()
      viewingUser = null
      document.getElementById('page-title').textContent = 'The Random Crap'
      document.getElementById('new-post').style.display = 'block'
      history.pushState(null, '', '/')
      loadPosts()
    }

    function viewProfile(username, e) {
      if (e) e.preventDefault()
      viewingUser = username
      document.getElementById('page-title').textContent = `@${username}'s crap`
      document.getElementById('new-post').style.display = username === currentUser?.username ? 'block' : 'none'
      history.pushState(null, '', `/${username}`)
      loadPosts()
    }

    // Handle browser back/forward
    window.addEventListener('popstate', () => {
      if (currentUser) {
        showApp()
      }
    })

    // Submit on Ctrl/Cmd + Enter
    document.getElementById('post-input').addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        createPost()
      }
    })

  </script>
  
  <div class="footer">
    Created by <a href="https://serverlord.in" target="_blank">@ServerLord</a> 
    (<a href="https://atharvakulkarni.link" target="_blank">Atharva Kulkarni</a>)
  </div>
</body>
</html>